<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Vulnerability Details</title>

    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">

    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
	<link rel="stylesheet" href="css/codemirror.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.css" />
	<script src="js/codemirror.js"></script>
	<script src="js/javascript.js"></script>
	<script src="js/autorefresh.js"></script>
	<script src="js/angular.min.js"></script>		
	<link rel="stylesheet" type="text/css" href="css/supportedstyle.css" />
	
	
  </head>
  <body ng-app="myapp" ng-controller="FailedObject">
  
    <div class="container-fluid">
		<div class="row">
			<div class="col-md-12">
				<div style="margin-bottom: 20px;">
					<!-- header -->
					<div class="heading">
						<h1 ng-bind="issueName"></h1>
					</div>  
					<!-- header -->
				</div>
				
				  <ul class="nav nav-tabs" id="myTab" role="tablist">
					<li class="nav-item waves-effect waves-light">
					  <a class="nav-link active" id="faq-tab" data-toggle="tab" href="#faq" role="tab" aria-controls="faq" aria-selected="false">FAQ</a>
					</li>				  
					<li class="nav-item waves-effect waves-light"> 
					  <a class="nav-link" id="remediation-tab" data-toggle="tab" href="#remediation" role="tab" aria-controls="remediation" aria-selected="false">Remediation</a>
					</li>
					<li class="nav-item waves-effect waves-light">
					  <a class="nav-link" id="mitigation-tab" data-toggle="tab" href="#mitigation" role="tab" aria-controls="mitigation" aria-selected="true">Mitigation</a>
					</li>		
					<li class="nav-item waves-effect waves-light">
					  <a class="nav-link" id="issuelist-tab" data-toggle="tab" href="#issueList" role="tab" aria-controls="issueList" aria-selected="true">Issue list</a>
					</li>					
				  </ul>
				  
				  <div class="tab-content" id="myTabContent"  style="margin:20px">
					<div class="tab-pane fade active show" id="faq" role="tabpanel" aria-labelledby="faq-tab">
						<div ng-repeat="faq in faqs">
							<div class="post-main-info">
								<p class="parent-p" style="border-bottom: 1px solid #ddd;"><strong>{{faq.question}}</strong></p>
								<p class="parent-p">{{faq.answer}}</p>	
							</div>
							<div>&nbsp;</div>
						</div>
						<div class="post-main-info" ng-if="faqs.length == 0;">
							<p style="text-align: center;">
							No data available
							</p>
						</div>
					</div>				  
					<div class="tab-pane fade" id="remediation" role="tabpanel" aria-labelledby="remediation-tab">

					<!-- remediation accordion start -->
					<div class="accordion md-accordion" id="remedAccMain" role="tablist" aria-multiselectable="true" >
						<!-- remediation section -->
						<!-- Accordion card -->
						<li ng-repeat="recommendation in recommendations" style="border-bottom: 1px solid #ddd;list-style-type:none;">
						  <div class="card">

							<!-- Card header -->
							<div class="card-header" role="tab" id="remedAccMain{{$index}}">
								  <a data-toggle="collapse" data-parent="#remedAccMain" href="#remedAccMainCollapse{{$index}}" ng-click="textAreaFunc()" aria-expanded="true"
									aria-controls="remedAccMainCollapse{{$index}}">
									<h6 class="mb-0">
									  [{{$index+1}}] {{recommendation.abstract}}
									</h6>
								  </a>
							</div>

							<!-- Card body -->
							<div id="remedAccMainCollapse{{$index}}" class="collapse" role="tabpanel" aria-labelledby="remedAccMain{{$index}}"
								  data-parent="#remedAccMain">
								<div class="card-body">
								<!-- Remediation Details -->
										<div><h4>Comments</h4></div>
										<div class="post-main-info">
											<div>
												<p>
													{{recommendation.comments}}
												</p>
											</div>
										</div>
										<div>&nbsp;</div>
										<div><h4>Impacts</h4></div>
										<div class="post-main-info">
										<div>
												<p>
													{{recommendation.impact}}
												</p>
											</div>
										</div>
										<div>&nbsp;</div>
										<div class="row">
											<div class="col-md-6 vuln">
												<label for="vuln">Vulnerable code</label>
												<textarea id="recomAccMainvulncode{{$index}}">
													{{recommendation.vulncode}}
												</textarea>	
											</div>
											<div class="col-md-6 nonvuln">
												<label for="nonvuln">Non-vulnerable code</label>
													<textarea id="recomAccMainnonvulncode{{$index}}">
													{{recommendation.nonvulncode}}
												</textarea>
											</div>
										</div>
										
								</div>
							</div>
						  </div>
						</li>
						  <!-- Accordion card -->						  						  
					</div>
					<!-- remediation accordion end -->
				</div>
				
			     	<!-- mitigation details start -->
                     <div class="tab-pane fade" id="mitigation" role="tabpanel" aria-labelledby="mitigation-tab">
				
					<!-- mitigationn accordion start -->
					<div class="accordion md-accordion" id="mitigAccMain" role="tablist" aria-multiselectable="true" >
						<!-- mitigation section -->
						
						  <!-- Accordion card -->
						  <li ng-repeat="mitigation in mitigations" style="border-bottom: 1px solid #ddd;list-style-type:none;">
						  <div class="card">

							<!-- Card header -->
							<div class="card-header" role="tab" id="mitigAccMain{{$index}}">
							  <a data-toggle="collapse" data-parent="#mitigAccMain" href="#mitigAccMainCollapse{{$index}}" ng-click="textAreaFunc()" aria-expanded="true"
								aria-controls="mitigAccMainCollapse{{$index}}">
								<h6 class="mb-0">
								  [{{$index+1}}] Mitigation - Web Server / IIS
								</h6>
							  </a>
							</div>

							<!-- Card body -->
							<div id="mitigAccMainCollapse{{$index}}" class="collapse" role="tabpanel" aria-labelledby="mitigAccMain{{$index}}"
							  data-parent="#mitigAccMain">
							  <div class="card-body">
							  <!-- Mitigation Details -->
								<div><h4>System</h4></div>
								<div class="post-main-info">
									<div>
										<p id="mitigAccMainsystem{{$index}}">{{mitigation.system}}										
										</p>
									</div>
								</div>
								<div>&nbsp;</div>
								<div><h4>Configuration</h4></div>
								<div class="post-main-info">
									<div>
										<p id="mitigAccMainconfiguration{{$index}}">{{mitigation.configuration}}										
										</p>
									</div>
								</div>
								<div>&nbsp;</div>
								<div><h4>Comments</h4></div>
								<div class="post-main-info">
									<div>
									<p id="mitigAccMaincomments{{$index}}">
									{{mitigation.comments}}
									</P>
									</div>
								</div>
								<div>&nbsp;</div>
								<div class="row">
									<div class="col-md-6 vuln">
										<label for="vuln">Backend</label>
										<textarea id="mitigAccMainvulncode{{$index}}">
										{{mitigation.backend}}
										</textarea>	
									</div>
									<div class="col-md-6 nonvuln">
										<label for="nonvuln">Frontend</label>
										<textarea id="mitigAccMainnonvulncode{{$index}}">
										{{mitigation.frontend}}
										</textarea>
									</div>
								</div>
							<!-- Mitigation Details -->
							  </div>
							</div>
						  </div>
						  </li>
						  <!-- Accordion card -->						
					  
					</div>
				</div>
				<div class="tab-pane fade" id="issueList" role="tabpanel" aria-labelledby="issueList-tab">	
					 <h3 ng-bind="'List of all issues in ' + (issueName)"></h3>
					
						<!-- issuelist accordion start -->
					<div class="accordion md-accordion" id="IssueListAccMain" role="tablist" aria-multiselectable="true" >
						<!-- issuelist section -->
						<!-- Accordion card -->
						<li ng-repeat="f in files" style="border-bottom: 1px solid #ddd;list-style-type:none;">
							<!-- Card header -->
							<div class="card-header" role="tab" id="IssueListAccMain{{$index}}">
								  <a data-toggle="collapse" data-parent="#IssueListAccMain" href="#remedAccMainCollapse{{$index}}" ng-click="textAreaFunc()" aria-expanded="true"
									aria-controls="remedAccMainCollapse{{$index}}">
									<h6 class="mb-0">
									  File: {{f.file}}
									</h6>
								  </a>
							</div>

							<!-- Card body -->
							<div id="remedAccMainCollapse{{$index}}" class="collapse" role="tabpanel" aria-labelledby="IssueListAccMain{{$index}}" data-parent="#IssueListAccMain">
							<div class="card-body">	  
								  <div class="accordion md-accordion" id="issueListAccSub{{itm.id}}" role="tablist" aria-multiselectable="true" > 
								  <div class="card">
									<div class="card-header" role="tab" >
									<!-- issuelist Details -->
											<ul ng-repeat="dr in f.items">
												<a data-toggle="collapse" data-parent="#IssueListAccMain{{$index}}" href="#remedSubAccMainCollapse{{files.indexOf(f)}}" aria-expanded="true"
													aria-controls="remedSubAccMainCollapse{{files.indexOf(f)}}">
													ID: {{dr.id}}&nbsp;&nbsp;&nbsp;&nbsp;Line: {{dr.line}}
												</a>
											 </ul>
									</div>
									<!-- issuelist Details -->
									<div id="remedSubAccMainCollapse{{$index}}" class="collapse" role="tabpanel" aria-labelledby="IssueListAccMain{{$index}}" data-parent="remedAccMainCollapse{{$index}}">
									  <div class="card-body">
										<ul ng-repeat="dr in f.items">
											<div class="col-md-11 vuln" style="width: 100%;">
												<label for="vuln">Snippet</label>
												<textarea id="Issuelistlvulncode{{$index}}">
														{{dr.originalCode.join('\n')}}
													</textarea>
											</div>
										</ul>
									  </div>
									</div>
									
									</div>
									</div>
								</div>	
	
							</div>
						</li>
						  <!-- Accordion card -->						  						  
					</div>
					<!-- Issue List accordion end -->	
				</div>
					
				</div>
			</div>
		</div>
	</div>
	
	<link rel="stylesheet" type="text/css" href="css/mergely.css" />	

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/scripts.js"></script>
	<script src="js/searchcursor.js"></script>	
	<script src="js/mergely.js"></script>
	<script src="js/codediff-mergely.js"></script>		
	<script src="data.json"></script>	
  </body>
	<script>
		var app = angular.module("myapp", []);
			app.controller("FailedObject", function($timeout, $scope) {				
				var url = new URL(window.location.href);
				_issueName = url.searchParams.get("vuln");
				$scope.issueName = _issueName;
				$scope.faqs = [];
				
				faqsObj = jsonData.project.failed[_issueName].remediation.remediation.faqs;
				
				if(faqsObj != null){
					if (Array.isArray(faqsObj.faq)){
						$scope.faqs = faqsObj.faq;
					}else{
						$scope.faqs.push(faqsObj.faq);
					}
				}
				
				$scope.files = jsonData.project.failed[_issueName].files;				
				$scope.mitigations = jsonData.project.failed[_issueName].remediation.remediation.mitigations.mitigation;
				$scope.recommendations = jsonData.project.failed[_issueName].remediation.remediation.recommendations.recommendation;

				//filesObj = jsonData.project.supported[_issueName].files;
				$scope.openTab = openTab;
				function openTab(evt, cityName) {
			// Declare all variables
					var i, tabcontent, tablinks;

					  // Get all elements with class="tabcontent" and hide them
					  tabcontent = document.getElementsByClassName("tabcontent");
					  for (i = 0; i < tabcontent.length; i++) {
						tabcontent[i].style.display = "none";
					  }

					  // Get all elements with class="tablinks" and remove the class "active"
					  tablinks = document.getElementsByClassName("tablinks");
					  for (i = 0; i < tablinks.length; i++) {
						tablinks[i].className = tablinks[i].className.replace(" active", "");
					  }

					  // Show the current tab, and add an "active" class to the button that opened the tab
					  document.getElementById(cityName).style.display = "block";
					  evt.currentTarget.className += " active";
					  //codeDiffMerge();
				}	
				$scope.codeDiffMerge=codeDiffMerge;
				function codeDiffMerge(index,originalcode,remediatedcode) {
					var i, mergelycontent, mergelyfullscreen,testvar;
					originalcode = originalcode.join('\n');
					remediatedcode = remediatedcode.join('\n');
					testvar = "mergely"+(index);
					mergelyfullscreen = document.getElementById(testvar);
							$('#mergely'+index).mergely({
								license: 'lgpl',
								cmsettings: {
									readOnly: true
								},
								width: 'auto',
								height: '300px',
								lhs: function(setValue) {
									setValue(originalcode);
								},
								rhs: function(setValue) {
									setValue(remediatedcode);
								}
							});					
				}
				var textAreaWhitelist = ["message"]
				$scope.scrub=scrub;
				function scrub(sourceText, valueToScrub){
					newTextValue = "";
					
					if(sourceText.length > 0){
						scrubIndex = sourceText.indexOf(valueToScrub);
						
						newTextValue = sourceText.substr(0, scrubIndex);
						newTextValue = newTextValue + sourceText.substr(scrubIndex + valueToScrub.length);
					}
					return newTextValue
				}
		
				$scope.textAreaFunc=textAreaFunc;
				$scope.isLoaded=false;
					function textAreaFunc(){
						var textAreas = Array.prototype.slice.call(document.getElementsByTagName("textarea"));
						if(textAreas != null && !$scope.isLoaded){
						for (i = 0; i < textAreas.length; i++) {
							if(!textAreaWhitelist.includes(textAreas[i].getAttribute("id"))){
							
								highlightObjects = []
								
								var emTags = [{s:"<em class=\"red\">",r:"red"}, {s:"<em class=\"blue\">",r:"blue"}, {s:"<em class=\"bold\">",r:"bold"}];
								
								//temporary fix replacing <em class="red"> tags
								newTextValue = textAreas[i].value;
								
								emTags.forEach(function(itemTag){
									// search for em tags
									index = newTextValue.indexOf(itemTag.s)-1;
									while(index > 0){
										startIndex = index;
										endIndex = newTextValue.indexOf("</em>", startIndex);
										
										lastCrStart = newTextValue.lastIndexOf("\n", startIndex);
										lineNumStart = newTextValue.substr(0, startIndex).split("\n").length-1;
										startIndex = index - lastCrStart;
										//startIndex -= itemTag.s.length;
										
										lastCrEnd = newTextValue.lastIndexOf("\n", endIndex);
										lineNumEnd = newTextValue.substr(0, endIndex).split("\n").length-1;
										endIndex = (endIndex - itemTag.s.length) - lastCrEnd;
										
										newTextValue = scrub(newTextValue, itemTag.s);
										newTextValue = scrub(newTextValue, "</em>");
										index = newTextValue.indexOf(itemTag.s);
										
										cName = ""
										switch(itemTag.r){
											case "red":
												cName = "vuln-highlight"; break;
											case "blue":
												cName = "nonvuln-highlight"; break;
											case "bold":
												cName = "bold"; break;
											default: cName = ""; break;
										}
										
										var styleObj = {
											from:{line: lineNumStart, ch: startIndex}, 
											to:{line: lineNumEnd, ch: endIndex}, 
											obj:{className: cName}
										}
										
										highlightObjects.push(styleObj);
									}
								});
								
								textAreas[i].value = newTextValue
							
								var editor = CodeMirror.fromTextArea(textAreas[i], {
										mode: "javascript", 
										autoRefresh: true,
										readOnly: true,
										lineNumbers: true
									});
								
								editor.setSize(null,500);
								
								highlightObjects.forEach(function(itemStyle){
									editor.markText(itemStyle.from, itemStyle.to, itemStyle.obj)
								});
								
								editor.save();
								editor.refresh();
							}
						}
						$scope.isLoaded=true;
						}
					};
				
		});
	</script>  
</html>
